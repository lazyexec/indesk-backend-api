// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  provider
  user
}

enum ClinicRole {
  clinician
  admin
  superAdmin
}

enum AppointmentStatus {
  pending
  completed
  cancelled
  scheduled
}

enum MeetingType {
  in_person
  zoom
}

enum Gender {
  male
  female
  other
}

enum IntegrationType {
  google_calendar
  stripe
  xero
  mailchimp
  whatsapp
  zoom
}

enum IntegrationStatus {
  connected
  disconnected
}

model User {
  id                 String         @id @default(uuid())
  email              String         @unique
  firstName          String?
  lastName           String?
  avatar             String?        @default("/uploads/users/user.png")
  password           String?
  role               Role           @default(user)
  oneTimeCode        String?
  oneTimeCodeExpires DateTime?
  isEmailVerified    Boolean        @default(false)
  isResetPassword    Boolean        @default(false)
  isDeleted          Boolean        @default(false)
  fcmToken           String?
  phoneNumber        Int?
  countryCode        String?
  // Status
  isRestricted       Boolean        @default(false)
  restrictionReason  String?
  // Business
  bio                String?
  // Timestamps
  isOnline           Boolean        @default(false)
  lastSeen           DateTime?
  lastLoginAt        DateTime?      @default(now())
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  // Relations
  tokens             Token[]
  ownedClinics       Clinic[]       @relation("ClinicOwner")
  clinicMemberships  ClinicMember[]
  appointments       Appointment[]  @relation("AppointmentClinician")
  addedAppointments  Appointment[]  @relation("AppointmentAddedBy")
  notes              ClinicalNote[]
  assessments        Assessment[]
  addedClients       Client[]       @relation("ClientAddedBy")
}

model Token {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  type      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

model Clinic {
  id          String  @id @default(uuid())
  name        String
  email       String? @unique
  phoneNumber String?
  address     Json?
  logo        String?
  // Simple permission system - JSON object with feature flags
  // Example: { "clients": true, "sessions": true, "billing": false }
  permissions Json    @default("{}")

  ownerId      String         @unique
  owner        User           @relation("ClinicOwner", fields: [ownerId], references: [id])
  // Relations
  members      ClinicMember[]
  clients      Client[]
  appointments Appointment[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  sessions  Session[]

  integrations Integration[]

  @@index([ownerId])
}

model Integration {
  id        String            @id @default(uuid())
  clinicId  String
  clinic    Clinic            @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  type      IntegrationType
  status    IntegrationStatus @default(disconnected)
  config    Json? // Stores credentials, IDs, tokens, etc.
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@unique([clinicId, type])
  @@index([clinicId])
}

model ClinicMember {
  id            String     @id @default(uuid())
  userId        String
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinicId      String
  clinic        Clinic     @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  role          ClinicRole @default(clinician)
  availability  String[]   @default([])
  specilization String[]   @default([])
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@unique([userId, clinicId])
  @@index([clinicId])
  @@index([userId])
}

model Client {
  id           String         @id @default(uuid())
  firstName    String
  lastName     String
  email        String
  dateOfBirth  DateTime
  gender       Gender         @default(male)
  phoneNumber  String?
  address      Json?
  // Notes
  note         String?
  // Belongs to clinic
  clinicId     String
  clinic       Clinic         @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  addedBy      String
  addedByUser  User           @relation("ClientAddedBy", fields: [addedBy], references: [id], onDelete: Cascade)
  // Relations
  appointments Appointment[]
  notes        ClinicalNote[]
  assessments  Assessment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
  @@index([email])
}

model Session {
  id       String @id @default(uuid())
  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  name     String

  duration     Int // in minutes
  description  String?
  price        Float
  color        String?
  reminders    Json? // e.g., [15, 30] minutes before
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  appointments Appointment[]

  @@index([clinicId])
}

model Appointment {
  id String @id @default(uuid())

  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  clinicianId String
  clinician   User   @relation("AppointmentClinician", fields: [clinicianId], references: [id])

  addedBy     String
  addedByUser User   @relation("AppointmentAddedBy", fields: [addedBy], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  sessionId String
  session   Session @relation(fields: [sessionId], references: [id])

  status AppointmentStatus @default(scheduled)

  startTime DateTime
  endTime   DateTime

  note String?

  // Online meeting (Zoom)
  meetingType   MeetingType @default(in_person) // IN_PERSON | ZOOM
  zoomJoinUrl   String?
  zoomStartUrl  String?
  zoomMeetingId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
  @@index([clinicianId])
  @@index([addedBy])
  @@index([clientId])
  @@index([startTime])
}

model ClinicalNote {
  id        String   @id @default(uuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  note      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([authorId])
}

model Assessment {
  id          String @id @default(uuid())
  clientId    String
  client      Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clinicianId String
  clinician   User   @relation(fields: [clinicianId], references: [id])

  title     String?
  note      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([clinicianId])
}
